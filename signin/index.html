<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <title>Sign In to the ARENA</title>
    <link href="//xr.andrew.cmu.edu/conix-x.png" rel="icon" type="image/png"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <script src="https://apis.google.com/js/api:client.js"></script>
    <script src="../vendor/jsrsasign-all-min.js" type="text/javascript"></script>
    <script src="../conf/defaults.js"></script>
    <script src="../auth.js"></script>
    <link href="../vendor/mdb/mdb.min.css" rel="stylesheet"/>
    <script src="../vendor/sweetalert.min.js"></script>
    <script src="../vendor/volume-meter.js"></script>
    <style>
        body {
            background-color: #32364d;
            font-family: 'Roboto', sans-serif;
        }

        .top-logo {
            max-height: 64px;
        }
        .title-logo {
            max-height: 32px;
        }
    </style>
</head>

<body>
<div class="d-none min-vh-100 routePage" id="landing">
    <div class="container-xxl">
        <div class="row pt-5 d-flex justify-content-between align-items-center">
            <div class="col-lg-4">
                <img alt="CONIX Logo" class="top-logo" src="../images/xr-logo-white-v7.png"/>
            </div>
            <div class="col-lg-4 text-end">
                <Button class="btn btn-white" id="loginPageBtn">Login</Button>
            </div>
        </div>
        <div class="row my-5">
            <div class="col px-0 bg-black">
                <div class="ratio ratio-16x9">
                     <iframe src="https://www.youtube-nocookie.com/embed/nZM-uiAPkqc?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="d-none d-flex align-items-center min-vh-100 routePage" id="signIn">
    <div class="container">
        <div class="row d-flex justify-content-center align-items-center">
            <div class="col-lg-4 col-md-6 shadow rounded bg-white p-5">
                <div class="row mb-3">
                    <h3>Login</h3>
                </div>
                <div class="row mb-5 text-center">
                    <div class="col">
                        <img alt="conix face logo" src="../images/conix-face-white.jpg"/>
                    </div>
                </div>
                <div class="row">
                    <form id="loginForm">
                        <div class="form-floating">
                            <select aria-label="Provider Select" class="form-select mb-3" id="provider">
                                <option value="anon">Anonymous</option>
                                <option value="google">Google</option>
                            </select>
                            <label for="provider">Authentication Provider</label>
                        </div>
                        <div class="form-outline mb-3" id="usernameContainer">
                            <input class="form-control" id="usernameInput" type="text">
                            <label class="form-label" for="usernameInput">User Name</label>
                        </div>
                        <button class="btn btn-white" id="anonBtn" type="submit">Sign In</button>
                        <div class="d-none" id="googleBtn">
                            <button class="btn btn-white" type="button">Google Sign In</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="d-none d-flex align-items-center min-vh-100 routePage" id="setup">
    <div class="container">
        <div class="row d-flex justify-content-center align-items-center">
            <div class="col-lg-8 p-5 col-md-10 shadow rounded bg-white">
                <div class="row mb-3">
                    <div class="col">
                        <button class="float-end btn btn-sm btn-outline-primary" id="redetectAVBtn">
                            Re-detect Devices <i class="fas fa-sync"></i>
                        </button>
                        <h3><img alt="CONIX Logo" class="title-logo" src="../images/xr-logo-v7.png"/> Setup</h3>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-7 mb-md-0 mb-3">
                        <div>
                            <video autoplay class="w-100 h-auto" id="vidPreview" muted playsinline></video>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-floating mb-3">
                            <select aria-label="Video Source" class="form-select mb-3" id="vidSourceSelect">
                            </select>
                            <label for="provider">Select Video Device</label>
                        </div>
                        <div class="form-floating">
                            <select aria-label="Speaker Device" class="form-select mb-3" id="audioOutSelect">
                                <option selected>No Device Detected</option>
                            </select>
                            <label for="provider">Select Speaker Device</label>
                        </div>
                        <button class="btn btn-sm btn-outline-primary mb-3" id="playTestAudioOutBtn">
                            Play Test Sound <i id="playTestAudioOutIcon" class="fas fa-volume-off"></i>
                        </button>
                        <audio id="testAudioOut" src="../media/step.ogg"></audio>
                        <div class="form-floating mb-3">
                            <select aria-label="Microphone Device" class="form-select mb-3" id="audioSourceSelect">
                            </select>
                            <label for="provider">Select Microphone Device</label>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div
                                    aria-valuemax="100"
                                    aria-valuemin="0"
                                    aria-valuenow="0"
                                    class="progress-bar progress-bar-striped bg-success"
                                    role="progressbar"
                                    style="width: 0"
                                    id="micMeter"
                            ></div>
                        </div>
                        <!-- Ref https://github.com/cwilso/volume-meter/ !-->
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="form-outline mb-3" id="displayName-input">
                            <input class="form-control" id="displayName" type="text">
                            <label class="form-label" for="displayName">Display Name</label>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">Scene URL</span>
                            <input
                                    aria-label="Scene URL"
                                    class="form-control"
                                    id="sceneURL"
                                    readonly
                                    type="text"
                                    value="https://arena.andrew.cmu.edu/foo/bar"
                            />
                            <button class="btn btn-primary" id="enterSceneAVBtn">Enter</button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <img alt="instruction video" id="demoAnim" class="w-100 h-auto" src="../images/intro_dialog_animation.gif"/>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="d-none d-flex align-items-center min-vh-100 routePage" id="sceneSelect">
    <div class="container">
        <div class="row d-flex justify-content-center align-items-center">
            <div class="col-lg-6 p-5 col-md-8 shadow rounded bg-white">
                <div class="row mb-3">
                    <div class="col">
                        <h3><img alt="CONIX Logo" class="title-logo" src="../images/xr-logo-v7.png"/> Welcome $user</h3>
                    </div>
                </div>
                <hr/>
                <div class="row mb-3">
                    <div class="col">
                        <div class="row mb-4">
                            <div class="col text-center">
                                <button class="btn btn-outline-primary" id="createSceneBtn">Create Scene</button>
                            </div>
                        </div>
                        <div class="row mb-3 row-cols-lg-auto g-3 align-items-center">
                            <div class="col-12">
                                <select aria-label="Scene Select" class="form-select me-3" id="userSceneSelect">
                                    <option value="1">Scene 1</option>
                                    <option value="2">Scene 2</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <button class="btn btn-outline-primary">Enter Scene</button>
                            </div>
                            <div class="col-12">
                                <button class="btn btn-outline-primary">Delete Scene</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="input-group mb-3">
                                    <span class="input-group-text">Scene URL</span>
                                    <input
                                            aria-label="Scene URL"
                                            class="form-control"
                                            id="sceneUrl2"
                                            readonly
                                            type="text"
                                            value="https://arena.andrew.cmu.edu/foo/bar"
                                    />
                                    <button class="btn btn-primary">Copy Link</button>
                                </div>
                            </div>
                        </div>
                        <hr/>
                        <h4 class="mb-3">Discover</h4>
                        <div class="row">
                            <div class="col-12">
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" placeholder="Scene Name" aria-label="Scene Name">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="input-group mb-3">
                                    <select aria-label="Public Scene Select" class="form-select" id="publicSceneSelect">
                                        <option value="1">Public Scene 1</option>
                                        <option value="2">Public Scene 2</option>
                                    </select>
                                    <button class="btn btn-primary" type="button">Enter Scene</button>
                                </div>
                            </div>
                        </div>
                        <hr/>
                        <h4>Advanced</h4>
                        <div class="row">
                            <div class="row mb-3 row-cols-lg-auto g-3 align-items-center">
                                <div class="col-12">
                                    <button class="btn btn-outline-primary">Builder </button>
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-outline-primary">Filestore</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="d-none d-flex align-items-center min-vh-100 routePage" id="createScene">
    <div class="container">
        <div class="row d-flex justify-content-center align-items-center">
            <div class="col-lg-6 p-5 col-md-8 shadow rounded bg-white">
                <div class="row mb-3">
                    <div class="col">
                        <h3><img alt="CONIX Logo" class="title-logo" src="../images/xr-logo-v7.png"/> Create a New Scene</h3>
                    </div>
                </div>
                <hr/>
                <div class="row mb-3">
                    <div class="col">
                        Buttons go here
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../vendor/mdb/mdb.min.js"></script>
<script>
    'use strict';

    document.addEventListener('DOMContentLoaded', function() {   // document.ready() equiv

        // Rudimentary routing based on location hash
        window.addEventListener('hashchange', function() {
            const validRoutes = [
                '#landing',
                '#signIn',
                '#setup',
                '#sceneSelect',
                '#createScene'
            ]
            const routePage = validRoutes.includes(window.location.hash) ? window.location.hash : '#landing';
            const pageEl = document.querySelector(routePage);
            hideEls(document.querySelectorAll(`.routePage:not(${routePage})`))
            showEl(pageEl, true);
            pageEl.dispatchEvent(new Event('routePageLoaded'));
        }, false);

        function showEl(el, flex = false) {
            const showClass = flex ? 'd-flex' : 'd-block';
            el.classList.add(showClass);
            el.classList.remove('d-none');
        }

        function hideEls(els, flex = false) {
            const showClass = flex ? 'd-flex' : 'd-block';
            for (let el of els) {
                el.classList.add('d-none');
                el.classList.remove(showClass);
            }
        }

        function changePage(page = 'landing') {
            if (window.location.hash !== page) {
                window.location.hash = page;
            }
        }

        document.getElementById('loginPageBtn').addEventListener('click', () => changePage('signIn'));
        const usernameContainer = document.getElementById('usernameContainer');
        const anonBtn = document.getElementById('anonBtn');
        const googleBtn = document.getElementById('googleBtn');
        document.getElementById('loginForm').addEventListener('change', ({target}) => {
            switch (target.value) {
                case 'google':
                    hideEls([usernameContainer, anonBtn]);
                    showEl(googleBtn);
                    break;
                case 'anon':
                    showEl(usernameContainer);
                    hideEls([googleBtn]);
                    showEl(anonBtn);
                    break;
                default:
                //
            }
        });

        // Ref : https://github.com/samdutton/simpl/blob/gh-pages/getusermedia/sources/js/main.js
        const videoElement = document.getElementById('vidPreview');
        const audioInSelect = document.getElementById('audioSourceSelect');
        const audioOutSelect = document.getElementById('audioOutSelect');
        const videoSelect = document.getElementById('vidSourceSelect');
        const testAudioOut = document.getElementById('testAudioOut');
        const testAudioOutBtn = document.getElementById('playTestAudioOutBtn');
        const testAudioOutIcon = document.getElementById('playTestAudioOutIcon');
        const micMeter = document.getElementById('micMeter');

        let mediaStreamSource = null;
        let meterProcess = null;
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioContext = new AudioContext();

        audioInSelect.onchange = getStream;
        videoSelect.onchange = getStream;
        // This will fail on a lot of browsers :(
        audioOutSelect.onchange = () => testAudioOut.setSinkId && testAudioOut.setSinkId(audioOutSelect.value);

        function getDevices() {
            // AFAICT in Safari this only gets default devices until gUM is called :/
            return navigator.mediaDevices.enumerateDevices();
        }

        function gotDevices(deviceInfos) {
            // Faster than innerHTML. No options have listeners so this is ok
            audioInSelect.textContent = '';
            audioOutSelect.textContent = '';
            videoSelect.textContent = '';
            window.deviceInfos = deviceInfos; // make available to console
            for (const deviceInfo of deviceInfos) {
                const option = document.createElement('option');
                option.value = deviceInfo.deviceId;
                switch (deviceInfo.kind) {
                   case 'audioinput':
                        option.text = deviceInfo.label || `Microphone ${audioInSelect.length + 1}`;
                        audioInSelect.appendChild(option);
                        break;
                    case 'audiooutput':
                        option.text = deviceInfo.label || `Speaker ${audioOutSelect.length + 1}`;
                        audioOutSelect.appendChild(option);
                        break;
                    case 'videoinput':
                        option.text = deviceInfo.label || `Camera ${videoSelect.length + 1}`;
                        videoSelect.appendChild(option);
                        break;
                    default:
                        //
                }
            }
            const noElementOption = document.createElement('option');
            noElementOption.setAttribute('selected', true);
            noElementOption.text = 'No Device Detected';
            if (!audioInSelect.childElementCount) {
                audioInSelect.appendChild(noElementOption.cloneNode(true));
            }
            audioInSelect.selectedIndex = 0;
            if (!videoSelect.childElementCount) {
                videoSelect.appendChild(noElementOption.cloneNode(true));
            }
            videoSelect.selectedIndex = 0;
            if (!audioOutSelect.childElementCount) {
                noElementOption.text = 'Default Device';
                audioOutSelect.appendChild(noElementOption.cloneNode(true));
            }
            audioOutSelect.selectedIndex = 0;
        }

        function getStream() {
            if (window.stream) {
                window.stream.getTracks().forEach(track => {
                    track.stop();
                });
            }
            const audioSource = audioInSelect.value;
            const videoSource = videoSelect.value;
            const constraints = {
                audio: {deviceId: audioSource ? {exact: audioSource} : undefined},
                video: {deviceId: videoSource ? {exact: videoSource} : undefined},
            };
            return navigator.mediaDevices.getUserMedia(constraints).
                then(gotStream).catch(handleMediaError);
        }

        function gotStream(stream) {
            window.stream = stream; // make stream available to console
            audioInSelect.selectedIndex = [...audioInSelect.options].
                findIndex(option => option.text === stream.getAudioTracks()[0].label);
            videoSelect.selectedIndex = [...videoSelect.options].
                findIndex(option => option.text === stream.getVideoTracks()[0].label);
            videoElement.srcObject = stream;


            // Scale video preview container
            let aspectRatioClass = '';
            const vidSettings = stream.getVideoTracks()[0].getSettings();
            switch ((vidSettings.width/vidSettings.height).toFixed(2)) {
                case '1.33':
                    aspectRatioClass = 'ratio ratio-4x3'
                    break;
                case '1.77':
                    aspectRatioClass = 'ratio ratio-16x9'
                    break;
                default:
                    //
            }
            videoElement.parentElement.setAttribute('class', aspectRatioClass);

            // Mic Test Meter via https://github.com/cwilso/volume-meter/
            meterProcess && meterProcess.shutdown();
            mediaStreamSource = audioContext.createMediaStreamSource(stream);
            meterProcess = createAudioMeter(audioContext);
            mediaStreamSource.connect(meterProcess)
            micDrawLoop();
        }

        function handleMediaError(error) {
            console.log('Error: ', error);
            swal('Oops...',
                `Could not initialize devices.
                Please ensure your devices are plugged in and allow browser audio and video access permissions.`,
                'error');
        }

        const detectDevices = () => {
            getStream().then(getDevices).then(gotDevices).catch(handleMediaError);
        };


        function micDrawLoop() {
            // set bar based on the current volume
            const vol = meterProcess.volume * 100 * 2;
            micMeter.setAttribute('style', `width: ${vol}%`);
            micMeter.setAttribute('aria-valuenow', '' + vol);
            // set up the next visual callback
            window.requestAnimationFrame( micDrawLoop );
        }

        testAudioOutBtn.addEventListener('click', () => {
            if (testAudioOut.paused) {
                testAudioOutIcon.setAttribute('class', 'fas fa-volume-up');
                testAudioOut.play();
            } else {
                testAudioOutIcon.setAttribute('class', 'fas fa-volume-off');
                testAudioOut.pause();
                testAudioOut.currentTime = 0;
            }
        });
        testAudioOutBtn.addEventListener("ended", () => {
            testAudioOutIcon.setAttribute('class', 'fas fa-volume-off');
        });

        document.getElementById('redetectAVBtn').addEventListener('click', detectDevices);
        document.getElementById('setup').addEventListener('routePageLoaded', detectDevices);
        document.getElementById('enterSceneAVBtn').addEventListener('click', () => changePage('sceneSelect'));
        document.getElementById('createSceneBtn').addEventListener('click', () => changePage('createScene'));
        document.getElementById('demoAnim').ondragstart = () => false;

        window.dispatchEvent(new Event('hashchange')); // Manually trigger initial hash routing

        /******************************************************************************************************/


        // TODO(mwfarb): App Store iOS build of WebXRViewer, G-Auth rejects the UA with 403

        // browser detection is not fun...
        var is_safari = navigator.userAgent.indexOf('Safari') > -1;
        var is_chrome = navigator.userAgent.indexOf('Chrome') > -1 || navigator.userAgent.indexOf('ChiOS') > -1;
        var is_firefox = navigator.userAgent.indexOf('Firefox') > -1 || navigator.userAgent.indexOf('FxiOS') > -1;
        var is_webxrviewer = navigator.userAgent.indexOf('WebXRViewer') > -1;
        var is_explorer = navigator.userAgent.indexOf('MSIE') > -1;
        var is_edge = navigator.userAgent.indexOf('Edg') > -1;
        var is_opera = navigator.userAgent.toLowerCase().indexOf('op') > -1;
        if ((is_edge) && (is_safari)) {
            is_safari = false;
        }
        if ((is_firefox) && (is_safari)) {
            is_safari = false;
        }
        if ((is_chrome) && (is_safari)) {
            is_safari = false;
        }
        if ((is_chrome) && (is_opera)) {
            is_chrome = false;
        }

        var urlParts = location.href.split('/');
        var rootPath = urlParts[0] + '//' + urlParts[2];

        const popupConfig = {
            client_id: defaults.gAuthClientId,
        };
        const redirectConfig = {
            client_id: defaults.gAuthClientId,
            ux_mode: 'redirect',
            redirect_uri: rootPath + '/signin/google/',
        };
        // Popup for this demo
        const gapiInitConfig = popupConfig;
        var auth2;
        var googleUser = {};
        var initGoogleAuth = function() {
            gapi.load('auth2', function() {
                auth2 = gapi.auth2.init(gapiInitConfig).then(function() {
                    auth2 = gapi.auth2.getAuthInstance();
                    attachGoogleSignin(googleBtn);
                    if (auth2.isSignedIn.get()) {
                        console.log('User is already signed in.');
                        var googleUser = auth2.currentUser.get();
                        onGoogleSignIn(googleUser);
                    }
                }, function(error) {
                    // Private browsing may get here, we handle the error, and
                    // provide anonymous sign in as an alternative.
                    console.error(error);
                    // TODO(mwfarb): gray out google button
                    // var nodes = document.getElementById("customBtnGoogle").getElementsByTagName('*');
                    // for (var i = 0; i < nodes.length; i++) {
                    //     nodes[i].disabled = true;
                    // }
                });
            });
        };

        function attachGoogleSignin(element) {
            auth2.attachClickHandler(element, {}, onGoogleSignIn, function(error) {
                alert(JSON.stringify(error, undefined, 2));
            });
        }

        function onGoogleSignIn(googleUser) {
            var profile = googleUser.getBasicProfile();
            console.log('Signed In: ' + profile.getEmail());
            localStorage.setItem('auth_choice', 'google');
            changePage('setup');
            // returnToRequestedPage();
        }

        function returnToRequestedPage() {
            if (localStorage.getItem('request_uri')) {
                //redirect user to originally requested page
                location.href = localStorage.getItem('request_uri');
            } else {
                location.href = '..'; // back to main ARENA
            }
        }

        const nameRegex = '^(?=[^A-Za-z]*[A-Za-z]{2,})[ -~]*$';
        const usernameInput = document.getElementById('usernameInput');
        usernameInput.setAttribute('pattern', nameRegex);

        document.getElementById('signIn').addEventListener('routePageLoaded', () => {
            if (localStorage.getItem('display_name')) {
                usernameInput.value = localStorage.getItem('display_name');
                usernameInput.focus();
            }
        })

        const initAnonAuth = function() {
            const re = new RegExp(nameRegex);
            const anonFormHandler = (e) => {
                e.preventDefault();
                // validate
                if (re.test(usernameInput.value)) {
                    // remove extra spaces
                    const displayName = usernameInput.value.replace(/\s+/g, ' ').trim();
                    localStorage.setItem('display_name', displayName);  // save for next use
                    localStorage.setItem('auth_choice', 'anonymous');
                    // returnToRequestedPage();
                    changePage('setup');
                }
            };
            document.getElementById('loginForm').addEventListener('submit', anonFormHandler);
        };
        initGoogleAuth();
        initAnonAuth();
    });
</script>
</body>
</html>

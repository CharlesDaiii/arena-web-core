parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"M7qK":[function(require,module,exports) {
async function e(e){const t=new Audio;t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline");const i=THREE.AudioContext.getContext(),o=i.createMediaStreamDestination(),a=new RTCPeerConnection,s=new RTCPeerConnection,d=e=>{console.error("RTCPeerConnection loopback initialization error",e)};a.addEventListener("icecandidate",e=>{s.addIceCandidate(e.candidate).catch(d)}),s.addEventListener("icecandidate",e=>{a.addIceCandidate(e.candidate).catch(d)}),s.addEventListener("track",e=>{t.srcObject=e.streams[0]});try{o.stream.getTracks().forEach(e=>{a.addTrack(e,o.stream)});const t=await a.createOffer();a.setLocalDescription(t),await s.setRemoteDescription(t);const n=await s.createAnswer();s.setLocalDescription(n),a.setRemoteDescription(n),e.disconnect(),ARENA.JitsiAPI.chromeSpatialAudioOn()?e.connect(i.destination):e.connect(o)}catch(r){d(r)}}AFRAME.registerComponent("arena-user",{schema:{color:{type:"color",default:"white"},jitsiId:{type:"string",default:""},displayName:{type:"string",default:""},hasAudio:{type:"boolean",default:!1},hasVideo:{type:"boolean",default:!1}},init:function(){const e=this.data,t=this.el,i=t.id;t.setAttribute("rotation.order","YXZ"),t.object3D.position.set(0,0,0),t.object3D.rotation.set(0,0,0);const o=decodeURI(i.split("_")[2]).normalize("NFD").replace(/[\u0300-\u036f]/g,"");this.headText=document.createElement("a-text"),this.headText.setAttribute("id","headtext_"+i),this.headText.setAttribute("value",o),this.headText.setAttribute("position","0 0.45 0.05"),this.headText.setAttribute("side","double"),this.headText.setAttribute("align","center"),this.headText.setAttribute("anchor","center"),this.headText.setAttribute("scale","0.4 0.4 0.4"),this.headText.setAttribute("rotation","0 180 0"),this.headText.setAttribute("color",e.color),this.headText.setAttribute("width",5),this.headModel=document.createElement("a-entity"),this.headModel.setAttribute("id","head-model_"+i),this.headModel.setAttribute("rotation","0 180 0"),this.headModel.object3D.scale.set(1,1,1),this.headModel.setAttribute("dynamic-body","type","static"),this.headModel.setAttribute("gltf-model","url(models/Head.gltf)"),t.appendChild(this.headText),t.appendChild(this.headModel),this.videoTrack=null,this.videoID=null,this.videoCubeDrawn=!1,this.audioTrack=null,this.audioSource=null,this.tick=AFRAME.utils.throttleTick(this.tick,1e3,this)},drawMicrophone(){const e=this.el,t="muted_"+e.id;let i=document.querySelector("#"+t);i||((i=document.createElement("a-image")).setAttribute("id",t),i.setAttribute("scale","0.2 0.2 0.2"),i.setAttribute("position","0 0.3 0.045"),i.setAttribute("src","url(src/icons/images/audio-off.png)"),e.appendChild(i))},removeMicrophone(){const e=this.el,t="muted_"+e.id,i=document.querySelector("#"+t);i&&e.removeChild(i)},drawVideoCube(){const e=this.el,t=document.createElement("a-box");t.setAttribute("id",this.videoID+"cube"),t.setAttribute("position","0 0 0"),t.setAttribute("scale","0.6 0.4 0.6"),t.setAttribute("material","shader","flat"),t.setAttribute("src",`#${this.videoID}`),t.setAttribute("material-extras","encoding","sRGBEncoding");const i=document.createElement("a-box");i.setAttribute("id",this.videoID+"cubeDark"),i.setAttribute("position","0 0 0.01"),i.setAttribute("scale","0.61 0.41 0.6"),i.setAttribute("material","shader","flat"),i.setAttribute("transparent","true"),i.setAttribute("color","black"),i.setAttribute("opacity","0.8"),e.appendChild(t),e.appendChild(i),this.videoCubeDrawn=!0},removeVideoCube(){const e=this.el,t=document.getElementById(this.videoID+"cube");e.contains(t)&&e.removeChild(t);const i=document.getElementById(this.videoID+"cubeDark");e.contains(i)&&e.removeChild(i),this.videoCubeDrawn=!1},aec(t){const i=THREE.AudioContext.getContext(),o=()=>{i.resume(),setTimeout(function(){"running"===i.state&&(!AFRAME.utils.device.isMobile()&&/chrome/i.test(navigator.userAgent)&&e(t.gain),document.body.removeEventListener("touchmove",o,!1),document.body.removeEventListener("mousemove",o,!1))},0)};document.body.addEventListener("touchmove",o,!1),document.body.addEventListener("mousemove",o,!1)},update:function(e){const t=this.data,i=this.el;if(t.displayName!==e.displayName){const e=t.displayName.normalize("NFD").replace(/[\u0300-\u036f]/g,"");this.headText.setAttribute("value",e)}if(ARENA.JitsiAPI.ready()&&t.jitsiId)if(this.videoID=`video${t.jitsiId}`,t.hasVideo?(this.videoTrack=ARENA.JitsiAPI.getVideoTrack(t.jitsiId),videoElem=document.getElementById(this.videoID),videoElem&&!this.videoCubeDrawn&&this.drawVideoCube()):(this.videoTrack&&(this.videoTrack.enabled=!1),this.removeVideoCube()),t.hasAudio){this.removeMicrophone();const e=ARENA.JitsiAPI.getAudioTrack(t.jitsiId);this.audioTrack=e.track;const o=new MediaStream;o.addTrack(this.audioTrack);const a=document.querySelector("a-scene");let s=null;if(a.audioListener)s=a.audioListener;else{s=new THREE.AudioListener,ARENA.sceneObjects.myCamera.object3D.add(s),a.audioListener=s}this.audioSource?this.audioSource.setMediaStreamSource(o):(this.audioSource=new THREE.PositionalAudio(s),this.audioSource.setMediaStreamSource(o),i.object3D.add(this.audioSource),ARENA.volume&&this.audioSource.setVolume(ARENA.volume),ARENA.refDist&&this.audioSource.setRefDistance(ARENA.refDist),ARENA.rolloffFact&&this.audioSource.setRolloffFactor(ARENA.rolloffFact),ARENA.distModel&&this.audioSource.setDistanceModel(ARENA.distModel)),this.aec(s)}else this.drawMicrophone(),this.audioTrack&&(this.audioTrack.enabled=!1)},tick:function(){const e=this.el,t=ARENA.sceneObjects.myCamera.object3D.position,i=e.object3D.position,o=t.distanceTo(i);if(this.videoTrack&&this.videoID){const e=ARENA.sceneObjects.myCamera.sceneEl.camera,t=new THREE.Frustum;t.setFromProjectionMatrix((new THREE.Matrix4).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse));const a=t.containsPoint(i),s=document.getElementById(this.videoID);!a||o>ARENA.maxAVDist?(this.videoTrack&&(this.videoTrack.enabled=!1),s&&!s.paused&&s.pause()):(this.videoTrack&&(this.videoTrack.enabled=!0),s&&s.paused&&s.play())}this.audioTrack&&(o>ARENA.maxAVDist?this.audioTrack&&(this.audioTrack.enabled=!1):this.audioTrack&&(this.audioTrack.enabled=!0))}});
},{}]},{},["M7qK"], null)
//# sourceMappingURL=/arena-user.08f03ff4.js.map